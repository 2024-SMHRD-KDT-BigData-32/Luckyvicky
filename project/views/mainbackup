<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=375, user-scalable=no" />
  <title>차밥</title>

  <!-- fullpage.js CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.css" />
  <link rel="stylesheet" href="/main.css" />
  <script defer src="../carinfo.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>

  <div class="mobile-frame">
    <div id="fullpage">
      <!-- 1. 첫 화면 - 차량 정보 -->
      <div class="section">
        <div class="wrapper dashboard">
          <!-- 상단 바 -->
          <div class="top-bar">
            <!-- 상단바 왼쪽 아이콘 -->
            <div class="left">
              <button class="menu-btn">
                <img src="/icon/menu.png" />
              </button>
            </div>

            <!-- 상단바 중앙 로고 부분-->
            <div class="center-logo">
              <img src="/icon/charbob_logo.png" />
            </div>

            <!-- 상단바 오른쪽 아이콘 -->
            <div class="right">
              <button id="carIconBtn" class="car_info-btn">
                <img src="/icon/car-side.png" />
              </button>
              <button class="mypage-btn" onclick="location.href='/user/mypage'">
                <img src="/icon/user.png" />
              </button>
            </div>
          </div>

          <!-- 첫페이지 본문 -->
          <div class="car-summary">
            <h3 id="carSummaryText">
              {% if isLoggedIn %}
              {% if hasCarInfo %}
              {{ user_name }}님의 차량
              {% else %}
              차량 등록이 필요합니다
              {% endif %}
              {% else %}
              환영합니다 차밥 싹싹김치
              {% endif %}
            </h3>

            <!-- <br/>
                <h2>
                    <img src="/icon/car.png" class="car-icon"/>
                    아반떼 (2024)
                </h2> -->
            <div class="car-header" id="carHeader">
              <img id="carImage" src="/car/{% if hasCarInfo %}{{ car_model }}1.jpg{% else %}default_car.png{% endif %}"
                alt="차 이미지" />
              <div class="car-header-info">
                <!-- <h2 id="carModel">{{ car_model }}</h2>
                <p id="carFuel">{{ fuel_type }}</p>
                <p id="carEfficiency">{{ fuel_efficiency }}km/L</p> -->
                {% if hasCarInfo %}
                <h2 id="carModel">{{ car_model }}</h2>
                <p id="carFuel">{{ fuel_type }}</p>
                <p id="carEfficiency">{{ fuel_efficiency }}km/L</p>
                {% else %}
                <h2 id="carModel">차량 등록하기</h2>
                <p id="carFuel"></p>
                <p id="carEfficiency"></p>
                {% endif %}
              </div>
            </div>


            <!-- 📦 HTML 전체 구조 (차량 정보 섹션 내부에 포함) -->
            <div class="dashboard-section">
              <div class="dashboard-cards">
                <div class="card">나의 평균 연비<br /><strong id="myAvgEfficiencyCard">-</strong></div>
                <div class="card">평균 주유 주기<br /><strong id="avgIntervalCard">-</strong></div>
                <div class="card">마지막 주유<br /><strong id="lastRefuelDateCard">-</strong><br /><small
                    id="lastRefuelPrice">-</small></div>
              </div>

              <div class="chart-box tightest-height">
                <h4>이번달 주유 그래프</h4>
                <canvas id="monthlyFuelLineChart"></canvas>
              </div>

              <div class="chart-box tightest-height">
                <h4>유가 추이</h4>
                <canvas id="nearbyPriceBarChart"></canvas>
              </div>

              <div class="chart-box tightest-height">
                <h4>주요 도시별 유가</h4>
                <canvas id="majorCityDonutChart"></canvas>
              </div>

              <div class="chart-box tightest-height">
                <h4>근처 도시별 유가</h4>
                <canvas id="nearbyCityDonutChart"></canvas>
              </div>
            </div>


          </div>



          <!-- 차량 정보 입력 모달 -->
          <div id="carModal">
            <div class="modal-content">
              <h3>차량 정보 입력</h3>
              <img id="modalCarImage" src="" alt="차 이미지" />

              <div id="carInfoForm">
                <select id="modalCar" name="car_model">
                  <option value="" disabled selected>차종 선택</option>
                  <option value="Avante">2024 아반떼CN7</option>
                  <option value="Sorento">2024 쏘렌토</option>
                  <option value="Grandeur">2024 그랜저</option>
                </select>
                <select id="modalFuel" name="fuel_type">
                  <option value="" disabled selected>유종 선택</option>
                  <option value="가솔린">휘발유</option>
                  <option value="디젤">경유</option>
                </select>
                <div class="unit-group">
                  <input type="number" id="modalEfficiency" name="fuel_efficiency" placeholder="연비 입력" />
                  <span>km/L</span>
                </div>
                <button type="button" onclick="saveCarInfo()">저장</button>
                <button type="button" onclick="closeModal()">닫기</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="wrapper">
          <h2>⛽ 최저가 주유소</h2>
          <p>광주광역시 북구 근처</p>
          <ul>
            <li>1. A 셀프주유소 – 1,490원</li>
            <li>2. B GS칼텍스 – 1,520원</li>
            <li>3. C SK에너지 – 1,540원</li>
          </ul>
        </div>
      </div>


      <!-- 섹션 3 내 위치 기반 주유소 찾기-->
      <div class="section">
        <div class="map_wrap">
          <div class="map-header">
            <!-- 상단바 왼쪽 홈으로 이동 버튼 추가 -->
            <button class="angle_up-btn" onclick="fullpage_api.moveTo(1)">
              <img src="/icon/angle-up.png" alt="화살표 아이콘" />
            </button>

            <div class="map-header-text">
              <h2>
                <img src="/icon/map-marker.png" alt="위치 아이콘" class="section3-icon" />
                내 위치 근처 주유소
              </h2>
              <p>현재 위치 기반 선택 반경 이내 주유소를 표시해줍니다.</p>
            </div>
          </div>

          <!-- 지도 div -->
          <div id="map" class="map-area"></div>

          <!-- 지도 아래 주유소 리스트 패널 -->
          <div id="stationPanel" class="station-panel">
            <div class="handle"></div>
            <!-- 거리 필터 버튼 -->
            <div class="distance-filter">
              <label for="distanceSelect">거리</label>
              <select id="distanceSelect">
                <option value="1500">1.5km 이내</option>
                <option value="3000" selected>3km 이내</option>
              </select>
            </div>

            <div id="stationList" class="station-list-scroll"></div>
          </div>
        </div>
      </div>


      <!-- 섹션 4 차계부-->
      <div class="section">
        <div class="wrapper">
          <h2>⛽ 차계부</h2>
          <p>차계부 입력</p>
        </div>
      </div>
    </div>

    <!-- 하단 고정 네비게이션 바-->
    <div class="nav-buttons">
      <button onclick="fullpage_api.moveTo(2)">
        <img src="/icon/gas-pump.png" class="nav-icon" />
        최저가 보기
      </button>
      <button onclick="fullpage_api.moveTo(3)">
        <img src="/icon/location.png" class="nav-icon" />
        근처 최저가
      </button>
      <button onclick="fullpage_api.moveTo(4)">
        <img src="/icon/calendar.png" class="nav-icon" />
        차계부
      </button>
    </div>
  </div>


  <div id="toast" class="toast">차량 정보가 저장되었습니다</div>

  <!-- fullpage.js script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/4.0.20/fullpage.min.js"></script>
  <script>
    new fullpage('#fullpage', {
      autoScrolling: true,
      navigation: true,
      scrollHorizontally: false,
      licenseKey: 'gplv3-license',
      afterRender: () => {
        if (typeof updateDashboardStats === 'function') {
          updateDashboardStats();
        }
      }
    });
  </script>
  <script
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e6dfab2f13622dce81330992b5eff90a&libraries=services"></script>
  <script src="/map.js"></script>


  <!-- <script>
    const carModal = document.getElementById("carModal");
    const carHeader = document.getElementById("carHeader");

    carHeader.addEventListener("click", () => {
      carModal.style.display = "block";
    });
  </script> -->
  <script>
    window.__IS_LOGGED_IN__ = "{{ isLoggedIn }}";
    window.__USER_NAME__ = "{{ user_name }}";
  </script>


  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/main.js"></script>

</body>

</html>



.container {
    width: 100%;
    height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  #calendar {
    height: 50%;
    background: #ffffff;
    padding: 8px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.15);
  }
  
  .chart-container {
    height: 24%;
    background: #ffffff;
    border-radius: 12px;
    padding: 6px;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.1);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .chart-container canvas {
    width: 100% !important;
    height: 80% !important;
  }
  
  .chart-caption {
    font-size: 10px;
    color: #2c3e50;
    text-align: left;
    font-weight: bold;
    margin: 2px 0;
  } */
  
  /* 차계부 모달 */
  .modal {
    display: none;
    position: absolute;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99;
    width: 90%;
    max-width: 400px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
  }
  
  .modal-content h3 {
    font-size: 18px;
    margin-bottom: 10px;
  }
  
  .modal-buttons button {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px;
    margin: 5px 0;
    font-size: 14px;
    border-radius: 8px;
    cursor: pointer;
  }
  
  /* 그래프 세션 */
  .dashboard-section {
    width: 100%;
    max-width: 375px;
    height: calc(100vh - 60px); /* 탭바가 60px이라 가정 */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 0.3rem 0.3rem 0.6rem;
    box-sizing: border-box;
    justify-content: flex-start; /* ✅ space-between 제거 */
  }
  
  .dashboard-cards {
    display: flex;
    justify-content: space-between;
    gap: 0.3rem;
  }
  
  .card {
    background: #ffffff;
    border-radius: 10px;
    padding: 4px;
    flex: 1;
    font-size: 0.6rem;
    color: #333;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  
  .card strong {
    font-size: 0.8rem;
    color: #1e90ff;
  }
  
  .chart-box {
    background: #ffffff;
    border-radius: 10px;
    padding: 6px;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex: 1;  /* ✅ 그래프 박스를 균등하게 분배 */
    min-height: 12vh;  /* ✅ 필요 최소 높이 */
    max-height: 15.5vh;
  }
  
  .chart-box h4 {
    font-size: 0.75rem;
    margin-bottom: 2px;
    color: #333;
  }
  
  .chart-box canvas {
    width: 100% !important;
    height: 100% !important;
    max-height: 100%; /* ✅ 부모 안에서만 그려지게 */
  }